<div class="chat-bubble assistant">
    <div class="meta">
        CapaRAG
        {% if answer.doc_ids %}
        <button class="entity-graph-btn" onclick="openEntityGraph(this)"
                data-doc-ids="{{ answer.doc_ids | join(',') }}">
            Entity Graph
        </button>
        {% endif %}
    </div>
    <div class="answer-text"><script type="text/markdown">{{ answer.answer }}</script></div>

    {% if answer.citations %}
    <div class="citations-block">
        {% for c in answer.citations %}
        <div class="citation-ref" id="cite-{{ c.index }}">
            <span class="cite-index">[{{ c.index }}]</span>
            <span class="cite-source">{{ c.source }}</span>
            {% if c.context_html %}
            <div class="citation-context">{{ c.context_html | safe }}</div>
            {% else %}
            <blockquote>{{ c.quote }}</blockquote>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {% if answer.sources %}
    <p><strong>Sources:</strong> {{ answer.sources | join(", ") }}</p>
    {% endif %}

    {% if answer.see_also %}
    <p><strong>See also:</strong>
        {% for term in answer.see_also %}
        <span class="see-also-tag">{{ term }}</span>
        {% endfor %}
    </p>
    {% endif %}

    <dialog class="entity-graph-modal" aria-labelledby="graph-title-{{ loop.index0 if loop is defined else '' }}">
        <div class="graph-header">
            <h2 id="graph-title-{{ loop.index0 if loop is defined else '' }}" class="graph-title">Entity Graph</h2>
            <button class="close-graph" aria-label="Close entity graph" onclick="closeEntityGraph(this)">&times;</button>
        </div>
        <div class="graph-tables" tabindex="-1"></div>
        <div class="graph-container" aria-hidden="true"></div>
    </dialog>
</div>
