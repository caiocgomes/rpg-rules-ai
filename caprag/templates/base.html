<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>CapaRAG{% block title_suffix %}{% endblock %}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
    <link rel="stylesheet" href="/static/style.css">
    <script src="/static/htmx.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vis-network@9/standalone/umd/vis-network.min.js"></script>
    <script>
        function renderAnswer(el) {
            var script = el.querySelector('script[type="text/markdown"]');
            if (!script) return;
            var md = script.textContent;
            // Ensure blank line before markdown block elements
            md = md.replace(/(#{1,6}\s)/g, '\n\n$1');
            md = md.replace(/([^\n])\n(\d+\.\s)/g, '$1\n\n$2');
            md = md.replace(/([^\n])\n([-*]\s)/g, '$1\n\n$2');
            // Collapse triple+ newlines back to double
            md = md.replace(/\n{3,}/g, '\n\n');
            var html = marked.parse(md);
            html = html.replace(/\[(\d+)\]/g, '<a href="#cite-$1" class="cite-marker" aria-label="Citation $1">[$1]</a>');
            el.innerHTML = html;
        }
        document.addEventListener('htmx:afterSwap', function(evt) {
            evt.detail.target.querySelectorAll('.answer-text').forEach(renderAnswer);
        });
        document.addEventListener('DOMContentLoaded', function() {
            document.querySelectorAll('.answer-text').forEach(renderAnswer);
        });

        var ENTITY_COLORS = {
            advantage: '#4CAF50', disadvantage: '#f44336', skill: '#2196F3',
            technique: '#FF9800', maneuver: '#9C27B0', spell: '#00BCD4',
            equipment: '#795548', modifier: '#607D8B', other: '#9E9E9E'
        };

        function buildEntityTables(data, tablesContainer) {
            var nodeMap = {};
            data.nodes.forEach(function(n) { nodeMap[n.id] = n; });

            var entityNodes = data.nodes.filter(function(n) { return n.type !== 'book'; });
            var bookNodes = data.nodes.filter(function(n) { return n.type === 'book'; });

            // Entities table
            if (entityNodes.length > 0) {
                var html = '<table><caption class="sr-only">Entities</caption>' +
                    '<thead><tr><th scope="col">Entity</th><th scope="col">Type</th></tr></thead><tbody>';
                entityNodes.forEach(function(n) {
                    html += '<tr><td>' + n.label + '</td><td>' + (n.entity_type || '') + '</td></tr>';
                });
                html += '</tbody></table>';
                tablesContainer.innerHTML = html;
            }

            // Relationships table
            if (data.edges.length > 0) {
                var html2 = '<table><caption class="sr-only">Relationships</caption>' +
                    '<thead><tr><th scope="col">From</th><th scope="col">Relation</th><th scope="col">To</th></tr></thead><tbody>';
                data.edges.forEach(function(e) {
                    var fromLabel = nodeMap[e.from] ? nodeMap[e.from].label : e.from;
                    var toLabel = nodeMap[e.to] ? nodeMap[e.to].label : e.to;
                    html2 += '<tr><td>' + fromLabel + '</td><td>' + (e.relation || '') + '</td><td>' + toLabel + '</td></tr>';
                });
                html2 += '</tbody></table>';
                tablesContainer.innerHTML += html2;
            }
        }

        function openEntityGraph(btn) {
            var docIds = btn.getAttribute('data-doc-ids');
            if (!docIds) return;
            var dialog = btn.closest('.chat-bubble').querySelector('.entity-graph-modal');
            if (!dialog) return;
            dialog._triggerBtn = btn;
            var container = dialog.querySelector('.graph-container');
            var tablesContainer = dialog.querySelector('.graph-tables');
            tablesContainer.innerHTML = '<p role="status">Loading entity graph...</p>';
            container.innerHTML = '';
            dialog.showModal();

            fetch('/api/entity-graph?chunks=' + encodeURIComponent(docIds))
                .then(function(r) { return r.json(); })
                .then(function(data) {
                    if (!data.nodes || data.nodes.length === 0) {
                        tablesContainer.innerHTML = '<p>No entities found for this answer.</p>';
                        tablesContainer.focus();
                        container.innerHTML = '';
                        return;
                    }
                    buildEntityTables(data, tablesContainer);
                    tablesContainer.focus();
                    var nodes = data.nodes.map(function(n) {
                        if (n.type === 'book') {
                            return {
                                id: n.id, label: n.label, shape: 'box',
                                color: { background: n.direct ? '#1565C0' : '#37474F', border: '#90CAF9' },
                                font: { color: '#fff', size: 14, face: 'monospace' },
                                borderWidth: n.direct ? 2 : 1
                            };
                        }
                        var col = ENTITY_COLORS[n.entity_type] || '#9E9E9E';
                        return {
                            id: n.id, label: n.label, shape: 'dot', size: n.direct ? 16 : 10,
                            color: { background: col, border: col },
                            font: { color: '#eee', size: 12 },
                            title: n.entity_type
                        };
                    });
                    var edges = data.edges.map(function(e) {
                        return {
                            from: e.from, to: e.to,
                            label: e.relation,
                            color: { color: e.direct ? '#90CAF9' : '#555', opacity: e.direct ? 0.9 : 0.4 },
                            font: { color: '#999', size: 9, strokeWidth: 0 },
                            dashes: !e.direct, width: e.direct ? 2 : 1
                        };
                    });
                    container.innerHTML = '';
                    new vis.Network(container,
                        { nodes: new vis.DataSet(nodes), edges: new vis.DataSet(edges) },
                        {
                            physics: { solver: 'forceAtlas2Based', forceAtlas2Based: { gravitationalConstant: -40 } },
                            interaction: { hover: true, tooltipDelay: 100 },
                            layout: { improvedLayout: true }
                        }
                    );
                })
                .catch(function() {
                    tablesContainer.innerHTML = '<p>Error loading entity graph.</p>';
                    container.innerHTML = '';
                });
        }

        function closeEntityGraph(btn) {
            var dialog = btn.closest('.entity-graph-modal');
            var triggerBtn = dialog._triggerBtn;
            dialog.close();
            if (triggerBtn) triggerBtn.focus();
        }
    </script>
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    <nav class="container" aria-label="Main navigation">
        <ul>
            <li><h1 class="nav-title">CapaRAG</h1></li>
        </ul>
        <ul>
            <li><a href="/"{% if active_page == "chat" %} aria-current="page"{% endif %}>Chat</a></li>
            <li><a href="/documents"{% if active_page == "documents" %} aria-current="page"{% endif %}>Documents</a></li>
            <li><a href="/prompts/page"{% if active_page == "prompts" %} aria-current="page"{% endif %}>Prompts</a></li>
        </ul>
    </nav>
    <main class="container" id="main-content">
        {% block content %}{% endblock %}
    </main>
</body>
</html>
